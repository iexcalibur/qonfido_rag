# Data Flow

End-to-end data flow through the RAG pipeline from user query to response.

## ğŸ”„ Complete Pipeline Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          1. USER QUERY                                       â”‚
â”‚                                                                              â”‚
â”‚  User Input: "Which funds have the best Sharpe ratio?"                      â”‚
â”‚  â””â”€ Frontend (ChatInput) â†’ POST /api/v1/query                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          2. API RECEIPT                                      â”‚
â”‚                                                                              â”‚
â”‚  FastAPI Endpoint (api/v1/query.py)                                         â”‚
â”‚  â”œâ”€ Validate Request (Pydantic schema)                                      â”‚
â”‚  â”œâ”€ Extract: query, search_mode, top_k, rerank                              â”‚
â”‚  â””â”€ Call: pipeline.process()                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          3. QUERY CACHE CHECK                                â”‚
â”‚                                                                              â”‚
â”‚  RAGPipeline.process()                                                      â”‚
â”‚  â”œâ”€ Generate cache key: hash(query + mode + top_k)                         â”‚
â”‚  â”œâ”€ Check QueryCache (5min TTL)                                             â”‚
â”‚  â””â”€ Cache Hit? â†’ Return cached response immediately                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ Cache Miss
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          4. QUERY EMBEDDING                                  â”‚
â”‚                                                                              â”‚
â”‚  Embedder.embed_query()                                                     â”‚
â”‚  â”œâ”€ Check EmbeddingCache (24hr TTL)                                         â”‚
â”‚  â”œâ”€ Cache Hit? â†’ Use cached embedding                                       â”‚
â”‚  â””â”€ Cache Miss? â†’ Generate embedding (BGE-M3 model)                         â”‚
â”‚     â””â”€ Query: "Which funds have the best Sharpe ratio?"                     â”‚
â”‚        â†’ [1024-dim vector]                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          5. DOCUMENT RETRIEVAL                               â”‚
â”‚                                                                              â”‚
â”‚  Based on search_mode:                                                      â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  LEXICAL MODE       â”‚  â”‚  SEMANTIC MODE      â”‚  â”‚  HYBRID MODE        â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚                     â”‚  â”‚                     â”‚ â”‚
â”‚  â”‚  LexicalSearcher    â”‚  â”‚  SemanticSearcher   â”‚  â”‚  HybridSearcher     â”‚ â”‚
â”‚  â”‚  â”œâ”€ Tokenize query  â”‚  â”‚  â”œâ”€ Use query       â”‚  â”‚  â”œâ”€ Parallel exec   â”‚ â”‚
â”‚  â”‚  â”œâ”€ BM25 search     â”‚  â”‚  â”‚   embedding      â”‚  â”‚  â”‚   (ThreadPool)    â”‚ â”‚
â”‚  â”‚  â””â”€ Rank by TF-IDF  â”‚  â”‚  â”œâ”€ ChromaDB query  â”‚  â”‚  â”œâ”€ Lexical search  â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚  â”‚   (cosine sim)    â”‚  â”‚  â”œâ”€ Semantic search â”‚ â”‚
â”‚  â”‚  Returns:           â”‚  â”‚  â””â”€ Rank by         â”‚  â”‚  â””â”€ RRF Fusion      â”‚ â”‚
â”‚  â”‚  [doc1, doc2, ...]  â”‚  â”‚     similarity      â”‚  â”‚                     â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚                     â”‚  â”‚  Returns:            â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚  Returns:           â”‚  â”‚  [doc1, doc2, ...]  â”‚ â”‚
â”‚  â”‚                     â”‚  â”‚  [doc1, doc2, ...]  â”‚  â”‚  (RRF combined)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  Each result contains:                                                      â”‚
â”‚  â”œâ”€ Document ID                                                             â”‚
â”‚  â”œâ”€ Text content                                                            â”‚
â”‚  â”œâ”€ Relevance score                                                         â”‚
â”‚  â”œâ”€ Source type (faq/fund)                                                  â”‚
â”‚  â””â”€ Metadata (fund_name, metrics, etc.)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          6. RERANKING (Optional)                             â”‚
â”‚                                                                              â”‚
â”‚  If rerank=True and Cohere API available:                                   â”‚
â”‚                                                                              â”‚
â”‚  Reranker.rerank()                                                          â”‚
â”‚  â”œâ”€ Extract texts from top results                                          â”‚
â”‚  â”œâ”€ Call Cohere Rerank API                                                  â”‚
â”‚  â”‚  â””â”€ Query + Documents â†’ Relevance scores                                 â”‚
â”‚  â”œâ”€ Reorder results by rerank scores                                        â”‚
â”‚  â””â”€ Return top_k reranked results                                           â”‚
â”‚                                                                              â”‚
â”‚  If rerank=False or API unavailable:                                        â”‚
â”‚  â””â”€ Skip reranking, use original results                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          7. CONTEXT PREPARATION                              â”‚
â”‚                                                                              â”‚
â”‚  Format retrieved documents for LLM:                                        â”‚
â”‚                                                                              â”‚
â”‚  Context = [                                                                â”‚
â”‚    {                                                                         â”‚
â”‚      "text": "Fund Name: XYZ Fund\nSharpe Ratio: 1.85\n...",                â”‚
â”‚      "source": "fund",                                                      â”‚
â”‚      "metadata": {"fund_name": "XYZ Fund", "sharpe_ratio": 1.85}            â”‚
â”‚    },                                                                        â”‚
â”‚    {                                                                         â”‚
â”‚      "text": "Question: What is Sharpe ratio?\nAnswer: ...",                â”‚
â”‚      "source": "faq",                                                       â”‚
â”‚      "metadata": {...}                                                      â”‚
â”‚    },                                                                        â”‚
â”‚    ...                                                                       â”‚
â”‚  ]                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          8. LLM GENERATION                                   â”‚
â”‚                                                                              â”‚
â”‚  LLMGenerator.generate()                                                    â”‚
â”‚                                                                              â”‚
â”‚  System Prompt:                                                             â”‚
â”‚  "You are a helpful financial assistant..."                                  â”‚
â”‚                                                                              â”‚
â”‚  User Message:                                                              â”‚
â”‚  """                                                                         â”‚
â”‚  Based on the following context, answer the user's question.                â”‚
â”‚                                                                              â”‚
â”‚  ## Context:                                                                â”‚
â”‚  [1] (FUND)                                                                 â”‚
â”‚  Fund Name: XYZ Fund                                                         â”‚
â”‚  Sharpe Ratio: 1.85                                                          â”‚
â”‚  ...                                                                         â”‚
â”‚                                                                              â”‚
â”‚  ## Question:                                                               â”‚
â”‚  Which funds have the best Sharpe ratio?                                     â”‚
â”‚  """                                                                         â”‚
â”‚                                                                              â”‚
â”‚  Claude API Call:                                                           â”‚
â”‚  â”œâ”€ Model: claude-3-opus-20240229                                           â”‚
â”‚  â”œâ”€ Max Tokens: 1024                                                        â”‚
â”‚  â””â”€ Temperature: 0.3                                                        â”‚
â”‚                                                                              â”‚
â”‚  Response:                                                                   â”‚
â”‚  "Based on the fund data, the funds with the best Sharpe ratios are:        â”‚
â”‚   1. XYZ Fund: Sharpe ratio of 1.85..."                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          9. RESPONSE ENRICHMENT                              â”‚
â”‚                                                                              â”‚
â”‚  RAGPipeline.process() continues:                                           â”‚
â”‚                                                                              â”‚
â”‚  â”œâ”€ Query Classification:                                                   â”‚
â”‚  â”‚  â””â”€ Analyze query + results â†’ "numerical" | "faq" | "hybrid"            â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”œâ”€ Fund Information Extraction:                                            â”‚
â”‚  â”‚  â””â”€ Extract fund metrics from result metadata                            â”‚
â”‚  â”‚     â†’ List of FundInfo objects                                           â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”œâ”€ Source Documents:                                                       â”‚
â”‚  â”‚  â””â”€ Build SourceDocument list from results                               â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â””â”€ Confidence Calculation:                                                 â”‚
â”‚     â””â”€ Average of top result scores â†’ 0.0-1.0                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          10. RESPONSE ASSEMBLY                               â”‚
â”‚                                                                              â”‚
â”‚  Build QueryResponse:                                                       â”‚
â”‚                                                                              â”‚
â”‚  {                                                                           â”‚
â”‚    "answer": "Based on the fund data...",                                   â”‚
â”‚    "query_type": "numerical",                                               â”‚
â”‚    "funds": [                                                               â”‚
â”‚      {                                                                       â”‚
â”‚        "fund_name": "XYZ Fund",                                             â”‚
â”‚        "sharpe_ratio": 1.85,                                                â”‚
â”‚        "cagr_3yr": 15.2,                                                    â”‚
â”‚        ...                                                                   â”‚
â”‚      }                                                                       â”‚
â”‚    ],                                                                        â”‚
â”‚    "sources": [                                                             â”‚
â”‚      {                                                                       â”‚
â”‚        "id": "fund_12",                                                     â”‚
â”‚        "text": "Fund Name: XYZ Fund...",                                    â”‚
â”‚        "source": "fund",                                                    â”‚
â”‚        "score": 0.92                                                        â”‚
â”‚      }                                                                       â”‚
â”‚    ],                                                                        â”‚
â”‚    "confidence": 0.85,                                                      â”‚
â”‚    "search_mode": "hybrid"                                                  â”‚
â”‚  }                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          11. CACHE UPDATE                                    â”‚
â”‚                                                                              â”‚
â”‚  Store response in QueryCache:                                              â”‚
â”‚  â”œâ”€ Key: hash(query + mode + top_k)                                        â”‚
â”‚  â”œâ”€ Value: QueryResponse (serialized)                                       â”‚
â”‚  â””â”€ TTL: 5 minutes                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          12. API RESPONSE                                    â”‚
â”‚                                                                              â”‚
â”‚  FastAPI serializes QueryResponse to JSON                                   â”‚
â”‚  â””â”€ HTTP 200 OK                                                             â”‚
â”‚     Content-Type: application/json                                          â”‚
â”‚     Body: { ... }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          13. FRONTEND RENDERING                              â”‚
â”‚                                                                              â”‚
â”‚  Frontend receives response:                                                â”‚
â”‚                                                                              â”‚
â”‚  â”œâ”€ Display answer in ChatMessage component                                 â”‚
â”‚  â”œâ”€ Show fund cards in FundAnalysisResults                                  â”‚
â”‚  â”œâ”€ Render source citations in CitationChip components                      â”‚
â”‚  â””â”€ Update chat history                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Initialization Flow (Startup)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          APPLICATION STARTUP                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          1. SERVER START                                     â”‚
â”‚                                                                              â”‚
â”‚  uvicorn app.main:app --reload                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          2. LIFESPAN STARTUP                                 â”‚
â”‚                                                                              â”‚
â”‚  main.py â†’ lifespan() function                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          3. FUND DATA LOADING                                â”‚
â”‚                                                                              â”‚
â”‚  Load funds from CSV:                                                       â”‚
â”‚  â”œâ”€ Read funds.csv                                                          â”‚
â”‚  â”œâ”€ Parse into FundData objects                                             â”‚
â”‚  â””â”€ Store in memory cache                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          4. DATA INGESTION                                   â”‚
â”‚                                                                              â”‚
â”‚  DataLoader:                                                                â”‚
â”‚  â”œâ”€ Load FAQs from faqs.csv                                                â”‚
â”‚  â”œâ”€ Load Funds from funds.csv                                              â”‚
â”‚  â”œâ”€ Convert to document format                                              â”‚
â”‚  â””â”€ Combine into unified document list                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          5. EMBEDDING GENERATION                             â”‚
â”‚                                                                              â”‚
â”‚  Embedder:                                                                   â”‚
â”‚  â”œâ”€ Load BGE-M3 model (or use cached)                                       â”‚
â”‚  â”œâ”€ Process documents in batches                                            â”‚
â”‚  â”œâ”€ Generate embeddings for all documents                                   â”‚
â”‚  â””â”€ Cache embeddings (24hr TTL)                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          6. INDEXING                                         â”‚
â”‚                                                                              â”‚
â”‚  Parallel indexing:                                                         â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  Lexical Index      â”‚      â”‚  Semantic Index     â”‚                      â”‚
â”‚  â”‚                     â”‚      â”‚                     â”‚                      â”‚
â”‚  â”‚  LexicalSearcher    â”‚      â”‚  SemanticSearcher   â”‚                      â”‚
â”‚  â”‚  â”œâ”€ Tokenize docs   â”‚      â”‚  â”œâ”€ ChromaDB        â”‚                      â”‚
â”‚  â”‚  â”œâ”€ Build BM25      â”‚      â”‚  â”‚   collection     â”‚                      â”‚
â”‚  â”‚  â”‚   index          â”‚      â”‚  â”œâ”€ Store vectors   â”‚                      â”‚
â”‚  â”‚  â””â”€ Ready           â”‚      â”‚  â””â”€ Ready           â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          7. READY STATE                                      â”‚
â”‚                                                                              â”‚
â”‚  Pipeline initialized and ready to serve queries                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Structures Flow

### Document Format

```
Document (from CSV) â†’ Document (indexed)
â”œâ”€ id: "fund_12"
â”œâ”€ text: "Fund Name: XYZ Fund\nSharpe Ratio: 1.85\n..."
â”œâ”€ source: "fund"
â””â”€ metadata:
   â”œâ”€ fund_name: "XYZ Fund"
   â”œâ”€ sharpe_ratio: 1.85
   â”œâ”€ cagr_3yr: 15.2
   â””â”€ ...
```

### Search Result Format

```
SearchResult
â”œâ”€ id: "fund_12"
â”œâ”€ text: "Fund Name: XYZ Fund..."
â”œâ”€ score: 0.92
â”œâ”€ source: "fund"
â””â”€ metadata: {...}
```

### Query Response Format

```
QueryResponse
â”œâ”€ answer: "Based on the fund data..."
â”œâ”€ query_type: "numerical"
â”œâ”€ funds: [FundInfo, ...]
â”œâ”€ sources: [SourceDocument, ...]
â”œâ”€ confidence: 0.85
â””â”€ search_mode: "hybrid"
```

---

## âš¡ Performance Optimizations

### Caching Layers

1. **Embedding Cache** (24hr TTL):
   - Avoids recomputing embeddings for same text
   - Hash-based lookup

2. **Query Cache** (5min TTL):
   - Instant response for repeated queries
   - Includes search mode and parameters

### Parallel Execution

- **Hybrid Search**: Lexical + Semantic run in parallel (ThreadPoolExecutor)
- **Batch Embedding**: Process multiple documents simultaneously

### Lazy Loading

- Embedding model loaded on first use
- ChromaDB initialized on first query
- Reranker loaded only if API key available

---

## ğŸ“Š Visual Diagrams

For interactive, color-coded flowcharts with detailed visualizations, see [DATA_FLOW_DIAGRAMS.md](../DATA_FLOW_DIAGRAMS.md) which includes:

- High-level system overview
- Detailed pipeline flows
- Parallel execution diagrams
- Frontend/backend interactions
- Cache and database flows

The visual diagrams are rendered using Mermaid (automatically on GitHub) and provide a more detailed view of system interactions.

---

For detailed technical architecture, see [Deep Architecture](deep-architecture.md).

